<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MAGOG IDE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material-darker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/show-hint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/lint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/foldgutter.min.css">

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/markdown/markdown.min.js"></script>
    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/xml-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/html-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/css-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/javascript-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jshint/2.13.6/jshint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/javascript-lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/brace-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/xml-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/comment-fold.min.js"></script>


    <style>
        :root { --header-height: 4rem; --sidebar-width: 4.5rem; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .view { display: none; height: 100%; }
        .view.active { display: flex; flex-direction: column; }
        .main-content { height: calc(100vh - var(--header-height)); }
        .CodeMirror { height: 100%; font-size: 14px; border-radius: 0.5rem; }
        .file-item-container, .folder-item-container { transition: background-color: 0.2s; }
        .file-item-container:hover, .folder-item-container:hover { background-color: #374151; }
        .file-item-container.selected, .folder-item-container.selected { background-color: #4338ca; }
        .folder-content { padding-left: 1.25rem; border-left: 1px solid #374151; margin-left: 0.625rem;}
        .sidebar-btn.active { color: #6366f1; background-color: #374151; }
        .context-menu { position: fixed; z-index: 1000; border-radius: 0.5rem; }
        .context-menu-item { padding: 0.75rem 1.25rem; cursor: pointer; color: white; display: flex; align-items: center; white-space: nowrap; }
        .context-menu-item:hover { background-color: rgba(255, 255, 255, 0.1); }
        .context-menu-item.delete { color: #f87171; }
        .context-menu-divider { height: 1px; background-color: rgba(255, 255, 255, 0.2); margin: 0.25rem 0; }
        .folder-arrow { transition: transform 0.2s; }
        .folder-arrow.rotate-90 { transform: rotate(90deg); }
        .project-card, .hub-card { transition: transform 0.2s, box-shadow 0.2s; }
        .project-card:hover, .hub-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.2), 0 4px 6px -2px rgba(79, 70, 229, 0.1); }
        .item-menu-btn { color: #9ca3af; }
        .item-menu-btn:hover { color: white; }
        #devSuiteView .CodeMirror { height: 150px; }
        .devsuite-tab { border-bottom: 2px solid transparent; }
        .devsuite-tab.active { border-color: #4f46e5; color: white; }
        .devsuite-panel { display: none; }
        .devsuite-panel.active { display: block; }
        .git-file-item { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; border-radius: 0.375rem; background-color: #374151; }
        .git-file-item:hover { background-color: #4b5563; }
        .git-action-btn { background-color: transparent; border: none; color: #9ca3af; cursor: pointer; padding: 0.25rem; }
        .git-action-btn:hover { color: white; }
        .glassmorphism {
            background: rgba(31, 41, 55, 0.6); /* bg-gray-800 with opacity */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .ai-message { padding: 0.75rem; border-radius: 0.5rem; max-width: 85%; }
        .ai-message.user { background-color: #4f46e5; align-self: flex-end; }
        .ai-message.assistant { background-color: #374151; align-self: flex-start; }
        .ai-message pre { white-space: pre-wrap; word-wrap: break-word; }
        .CodeMirror-hints {
            background-color: #1f2937 !important;
            color: white !important;
            border: 1px solid #4b5563 !important;
        }
        .CodeMirror-hint-active {
            background-color: #4f46e5 !important;
            color: white !important;
        }
        .search-result-item { cursor: pointer; }
        .search-result-item:hover { background-color: #374151; }
        .search-result-item .match { background-color: #fbbf24; color: #1f2937; font-weight: bold; }
        .asset-svg-wrapper { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; padding: 0.5rem; }
        .asset-svg-wrapper svg { width: 100%; height: 100%; object-fit: contain; }
        .delete-asset-btn { position: absolute; top: 0.5rem; right: 0.5rem; background-color: rgba(0,0,0,0.5); border-radius: 9999px; padding: 0.25rem; display: none; }
        .group:hover .delete-asset-btn { display: block; }
        .delete-asset-btn:hover { background-color: rgba(239, 68, 68, 0.8); }
        .editor-panel-container { width: calc(100% - var(--sidebar-width)); }
        #canvasView .CodeMirror { font-size: 16px; }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col items-center justify-center p-0 md:p-4">
    <input type="file" id="fileUploader" class="hidden" accept=".html,.css,.js,.txt,.md,.json">
    <input type="file" id="assetUploader" class="hidden" accept=".svg,.json,.txt,.md">

    
    <div id="authView" class="view w-full max-w-md items-center justify-center" style="background-image: url('https://images.unsplash.com/photo-1531366936337-7c912a4589a7?q=80&w=2070&auto=format&fit=crop'); background-size: cover; background-position: center;">
         <div class="bg-gray-900 bg-opacity-75 rounded-none md:rounded-2xl shadow-2xl p-8 border-y md:border border-gray-700 h-full md:h-auto w-full flex flex-col justify-center">
            <div class="mb-8 text-center"><h2 class="text-3xl font-bold">Login to MAGOG</h2></div>
            <div class="flex border-b border-gray-700 mb-6">
                <button id="loginSwitch" class="form-switch-btn flex-1 py-2 text-gray-400 font-medium">Login</button>
                <button id="registerSwitch" class="form-switch-btn flex-1 py-2 text-gray-400 font-medium">Register</button>
            </div>
            <form id="loginForm" class="space-y-6">
                <div><label for="loginEmail" class="block text-sm font-medium text-gray-300">Email</label><input type="email" id="loginEmail" required class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md p-3 text-white focus:ring-indigo-500 focus:border-indigo-500"></div>
                <div><label for="loginPassword" class="block text-sm font-medium text-gray-300">Password</label><input type="password" id="loginPassword" required class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md p-3 text-white focus:ring-indigo-500 focus:border-indigo-500"></div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg">Login</button>
            </form>
            <form id="registerForm" class="space-y-6 hidden">
                <div><label for="registerEmail" class="block text-sm font-medium text-gray-300">Email</label><input type="email" id="registerEmail" required class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md p-3 text-white focus:ring-indigo-500 focus:border-indigo-500"></div>
                <div><label for="registerPassword" class="block text-sm font-medium text-gray-300">Password</label><input type="password" id="registerPassword" required class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md p-3 text-white focus:ring-indigo-500 focus:border-indigo-500"></div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg">Create Account</button>
            </form>
            <div id="authMessageBox" class="mt-4 text-center text-sm text-red-400"></div>
         </div>
    </div>

    
    <div id="homeView" class="view w-full h-full overflow-y-auto">
        <div class="w-full max-w-6xl mx-auto flex flex-col min-h-full p-4 py-8">
            <header class="text-center mb-12">
                <h1 class="text-5xl font-extrabold tracking-tight text-white sm:text-6xl">MAGOG</h1>
                <p class="mt-4 text-lg text-gray-400">Your Development Command Center</p>
            </header>
            <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div id="hubEditorBtn" class="hub-card bg-gray-800 rounded-2xl p-8 cursor-pointer border border-gray-700 hover:border-indigo-500 flex flex-col items-center text-center">
                    <img src="https://raw.githubusercontent.com/juugboytv/Geminus/refs/heads/Spells/IMG_3908.png" alt="Code Editor Icon" class="w-20 h-20 rounded-full mb-4 object-cover border-2 border-indigo-500">
                    <h2 class="text-2xl font-bold">Code Editor</h2>
                    <p class="text-gray-400 mt-2">Open your projects and build with the full-featured IDE.</p>
                </div>
                <div id="hubDevSuiteBtn" class="hub-card bg-gray-800 rounded-2xl p-8 cursor-pointer border border-gray-700 hover:border-indigo-500 flex flex-col items-center text-center">
                    <img src="https://raw.githubusercontent.com/juugboytv/Geminus/refs/heads/main/IMG_3895.png" alt="DevSuite Icon" class="w-20 h-20 rounded-full mb-4 object-cover border-2 border-teal-500">
                    <h2 class="text-2xl font-bold">DevSuite</h2>
                    <p class="text-gray-400 mt-2">Tools to refactor, combine, and manage code.</p>
                </div>
                <div id="hubGitBtn" class="hub-card bg-gray-800 rounded-2xl p-8 cursor-pointer border border-gray-700 hover:border-indigo-500 flex flex-col items-center text-center">
                    <img src="https://raw.githubusercontent.com/juugboytv/Geminus/refs/heads/main/IMG_3891.jpeg" alt="GitHub Icon" class="w-20 h-20 rounded-full mb-4 object-cover border-2 border-gray-500">
                    <h2 class="text-2xl font-bold">GitHub</h2>
                    <p class="text-gray-400 mt-2">Connect repos, commit, and push changes.</p>
                </div>
                <div id="hubAiBtn" class="hub-card bg-gray-800 rounded-2xl p-8 cursor-pointer border border-gray-700 hover:border-indigo-500 flex flex-col items-center text-center">
                    <img src="https://raw.githubusercontent.com/juugboytv/Geminus/main/IMG_3893.jpeg" alt="AI Assistant Icon" class="w-20 h-20 rounded-full mb-4 object-cover border-2 border-purple-500">
                    <h2 class="text-2xl font-bold">AI Assistant</h2>
                    <p class="text-gray-400 mt-2">Ask questions, get ideas, and plan your projects.</p>
                </div>
                <div id="hubCanvasBtn" class="hub-card bg-gray-800 rounded-2xl p-8 cursor-pointer border border-gray-700 hover:border-indigo-500 flex flex-col items-center text-center">
                    <img src="https://raw.githubusercontent.com/juugboytv/Geminus/main/IMG_3958.jpg" alt="Canvas Icon" class="w-20 h-20 rounded-full mb-4 object-cover border-2 border-blue-500">
                    <h2 class="text-2xl font-bold">MAGOG Canvas</h2>
                    <p class="text-gray-400 mt-2">A collaborative space for writing and brainstorming.</p>
                </div>
            </main>
             <footer class="text-center mt-12">
                <button id="logoutBtn" class="text-gray-500 hover:text-white">Logout</button>
            </footer>
        </div>
    </div>

    
    <div id="canvasView" class="view w-full h-full">
        <header class="bg-gray-800 p-4 flex justify-between items-center border-b border-gray-700 flex-shrink-0 h-[var(--header-height)]">
            <div class="flex items-center">
                 <button id="canvasViewBackBtn" class="p-2 rounded-full hover:bg-gray-700 mr-2" title="Back to Home"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
                <h1 class="text-2xl font-bold">MAGOG Canvas</h1>
            </div>
            <button id="canvasAiSettingsBtn" class="p-2 rounded-full hover:bg-gray-700" title="AI Settings">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            </button>
        </header>
        <main class="flex-grow flex flex-col md:flex-row gap-4 p-4 overflow-hidden">
            <div class="flex-grow md:w-2/3 h-1/2 md:h-full flex flex-col">
                <textarea id="canvasEditor"></textarea>
            </div>
            <div class="flex-grow md:w-1/3 h-1/2 md:h-full bg-gray-800 rounded-lg p-4 flex flex-col overflow-hidden">
                <h2 class="text-xl font-bold mb-4 flex-shrink-0">Canvas AI</h2>
                <div id="canvasAiChatContainer" class="flex-grow overflow-y-auto mb-4 space-y-4 flex flex-col pr-2"></div>
                <div class="flex-shrink-0 space-y-2 pb-4">
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <button class="canvas-ai-action-btn bg-gray-700 hover:bg-gray-600 p-2 rounded-md" data-prompt="Summarize the text in the editor.">Summarize</button>
                        <button class="canvas-ai-action-btn bg-gray-700 hover:bg-gray-600 p-2 rounded-md" data-prompt="Continue writing based on the text in the editor.">Continue</button>
                        <button class="canvas-ai-action-btn bg-gray-700 hover:bg-gray-600 p-2 rounded-md" data-prompt="Check for grammar and spelling errors in the text.">Check Grammar</button>
                        <button class="canvas-ai-action-btn bg-gray-700 hover:bg-gray-600 p-2 rounded-md" data-prompt="Brainstorm ideas based on the text.">Brainstorm</button>
                    </div>
                    <div class="flex items-center">
                        <input type="text" id="canvasAiInput" class="w-full bg-gray-700 border-gray-600 rounded-l-md p-3 text-white focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ask about the text...">
                        <button id="canvasAiSendBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold p-3 rounded-r-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    
    <div id="aiView" class="view w-full h-full">
        <header class="bg-gray-800 p-4 flex justify-between items-center border-b border-gray-700 flex-shrink-0 h-[var(--header-height)]">
            <div class="flex items-center">
                 <button id="aiViewBackBtn" class="p-2 rounded-full hover:bg-gray-700 mr-2" title="Back to Home"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
                <h1 class="text-2xl font-bold">AI Assistant</h1>
            </div>
             <button id="hubAiSettingsBtn" class="p-2 rounded-full hover:bg-gray-700" title="AI Settings">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            </button>
        </header>
        <main class="flex-grow flex flex-col p-4 md:p-6 pb-16 md:pb-6 overflow-hidden">
            <div id="hubAiChatContainer" class="flex-grow overflow-y-auto mb-4 space-y-4 flex flex-col pr-2">
                
                <div class="ai-message assistant">Hello! How can I help you today?</div>
            </div>
            <div class="flex-shrink-0 space-y-2">
                <div class="flex items-center">
                    <input type="text" id="hubAiInput" class="w-full bg-gray-700 border-gray-600 rounded-l-md p-3 text-white focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ask the AI assistant anything...">
                    <button id="hubAiSendBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold p-3 rounded-r-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>
                    </button>
                </div>
            </div>
        </main>
    </div>

    
    <div id="devSuiteView" class="view w-full h-full">
        <header class="bg-gray-800 p-4 flex justify-between items-center border-b border-gray-700 flex-shrink-0 h-[var(--header-height)]">
            <div class="flex items-center">
                 <button id="devSuiteBackBtn" class="p-2 rounded-full hover:bg-gray-700 mr-2" title="Back to Home"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
                <h1 class="text-2xl font-bold">DevSuite</h1>
            </div>
        </header>
        <main id="devSuiteMain" class="flex-grow p-4 md:p-6 overflow-y-auto">
            <div class="flex border-b border-gray-700 mb-6 text-sm md:text-base">
                <button data-tab="breakdown" class="devsuite-tab flex-1 py-2 text-gray-400 font-medium">Canvas Breakdown</button>
                <button data-tab="combine" class="devsuite-tab flex-1 py-2 text-gray-400 font-medium">Inline Combine</button>
                <button data-tab="merge" class="devsuite-tab flex-1 py-2 text-gray-400 font-medium">Gemini Canvas</button>
            </div>
            
            
            <div id="breakdownPanel" class="devsuite-panel space-y-6">
                 <div>
                    <label class="block text-lg font-medium text-gray-300 mb-2">1. Get Combined Code</label>
                    <div class="flex space-x-2 mb-2">
                        <button class="devsuite-upload-btn flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded-md text-sm" data-target="breakdownInput">Upload File</button>
                        <button class="devsuite-import-btn flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded-md text-sm" data-target="breakdownInput">Import from Project</button>
                    </div>
                    <textarea id="breakdownInput" class="w-full bg-gray-700 border-gray-600 rounded-md p-3 text-white h-40" placeholder="Paste your single block of code from Gemini Canvas here..."></textarea>
                    <button id="breakdownBtn" class="mt-4 w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-lg">Breakdown Code</button>
                </div>
                <div id="breakdownOutputContainer" class="hidden space-y-6">
                    <hr class="border-gray-600">
                    <div>
                        <div class="flex justify-between items-center mb-2"><h3 class="text-lg font-medium text-gray-300">HTML Output</h3><div><button class="copy-btn bg-gray-600 hover:bg-gray-500 text-sm py-1 px-3 rounded-md" data-target="html">Copy</button><button class="download-btn bg-gray-600 hover:bg-gray-500 text-sm py-1 px-3 rounded-md" data-target="html">Download</button></div></div>
                        <div id="htmlOutput"></div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2"><h3 class="text-lg font-medium text-gray-300">CSS Output</h3><div><button class="copy-btn bg-gray-600 hover:bg-gray-500 text-sm py-1 px-3 rounded-md" data-target="css">Copy</button><button class="download-btn bg-gray-600 hover:bg-gray-500 text-sm py-1 px-3 rounded-md" data-target="css">Download</button></div></div>
                        <div id="cssOutput"></div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2"><h3 class="text-lg font-medium text-gray-300">JavaScript Output</h3><div><button class="copy-btn bg-gray-600 hover:bg-gray-500 text-sm py-1 px-3 rounded-md" data-target="js">Copy</button><button class="download-btn bg-gray-600 hover:bg-gray-500 text-sm py-1 px-3 rounded-md" data-target="js">Download</button></div></div>
                        <div id="jsOutput"></div>
                    </div>
                    <hr class="border-gray-600">
                    <button id="addToProjectBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg">Add Files to Project</button>
                </div>
            </div>

            
            <div id="combinePanel" class="devsuite-panel space-y-6">
                 <div>
                    <label class="block text-lg font-medium text-gray-300 mb-2">1. Add Your Code</label>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">HTML</label>
                            <div class="flex space-x-2 mb-1">
                                <button class="devsuite-upload-btn flex-1 bg-gray-700 hover:bg-gray-600 py-1 rounded-md text-xs" data-target="combineHtml">Upload</button>
                                <button class="devsuite-import-btn flex-1 bg-gray-700 hover:bg-gray-600 py-1 rounded-md text-xs" data-target="combineHtml">Import</button>
                            </div>
                            <div id="combineHtmlInput"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">CSS</label>
                             <div class="flex space-x-2 mb-1">
                                <button class="devsuite-upload-btn flex-1 bg-gray-700 hover:bg-gray-600 py-1 rounded-md text-xs" data-target="combineCss">Upload</button>
                                <button class="devsuite-import-btn flex-1 bg-gray-700 hover:bg-gray-600 py-1 rounded-md text-xs" data-target="combineCss">Import</button>
                            </div>
                            <div id="combineCssInput"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-400 mb-1">JavaScript</label>
                             <div class="flex space-x-2 mb-1">
                                <button class="devsuite-upload-btn flex-1 bg-gray-700 hover:bg-gray-600 py-1 rounded-md text-xs" data-target="combineJs">Upload</button>
                                <button class="devsuite-import-btn flex-1 bg-gray-700 hover:bg-gray-600 py-1 rounded-md text-xs" data-target="combineJs">Import</button>
                            </div>
                            <div id="combineJsInput"></div>
                        </div>
                    </div>
                    <button id="combineBtn" class="mt-4 w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-lg">Combine Code</button>
                </div>
                 <div id="combineOutputContainer" class="hidden space-y-6">
                    <hr class="border-gray-600">
                    <div>
                        <div class="flex justify-between items-center mb-2"><h3 class="text-lg font-medium text-gray-300">Combined Output</h3><div><button class="copy-btn bg-gray-600 hover:bg-gray-500 text-sm py-1 px-3 rounded-md" data-target="combined">Copy</button><button class="download-btn bg-gray-600 hover:bg-gray-500 text-sm py-1 px-3 rounded-md" data-target="combined">Download</button></div></div>
                        <div id="combinedOutput"></div>
                    </div>
                </div>
            </div>
            
            
            <div id="mergePanel" class="devsuite-panel space-y-6">
                <div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-lg font-medium text-gray-300 mb-2">1. Current Code</label>
                            <div id="mergeCurrentInput"></div>
                        </div>
                        <div>
                            <label class="block text-lg font-medium text-gray-300 mb-2">2. New Code Snippet</label>
                            <div id="mergeNewInput"></div>
                        </div>
                    </div>
                    <button id="mergeBtn" class="mt-4 w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-lg">Merge Code</button>
                </div>
                <div id="mergeOutputContainer" class="hidden space-y-6">
                    <hr class="border-gray-600">
                    <div>
                        <div class="flex justify-between items-center mb-2"><h3 class="text-lg font-medium text-gray-300">Merged Output</h3><div><button class="copy-btn bg-gray-600 hover:bg-gray-500 text-sm py-1 px-3 rounded-md" data-target="merged">Copy</button><button class="download-btn bg-gray-600 hover:bg-gray-500 text-sm py-1 px-3 rounded-md" data-target="merged">Download</button></div></div>
                        <div id="mergedOutput"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    
    <div id="dashboardView" class="view w-full h-full">
        <header class="bg-gray-800 p-4 flex justify-between items-center border-b border-gray-700 flex-shrink-0">
             <div class="flex items-center">
                 <button id="dashboardBackBtn" class="p-2 rounded-full hover:bg-gray-700 mr-2" title="Back to Home"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
                <h1 class="text-2xl font-bold">My Projects</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="newProjectBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>New Project</button>
            </div>
        </header>
        <main id="projectList" class="flex-grow p-4 md:p-8 overflow-y-auto grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></main>
    </div>

    
    <div id="editorView" class="view w-full h-full">
        <header class="bg-gray-800 p-3 flex justify-between items-center border-b border-gray-700 h-[var(--header-height)] flex-shrink-0 glassmorphism">
            <div class="flex items-center">
                <button id="backToProjectsBtn" class="p-2 rounded-full hover:bg-gray-700 mr-2" title="Back to Projects"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
                <h1 id="headerTitle" class="text-xl font-bold truncate"></h1>
            </div>
            <div id="headerActions" class="flex items-center space-x-3">
                <button id="runButton" class="p-2 rounded-full hover:bg-gray-700" title="Run Project"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
                <button id="saveButton" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200">Save</button>
            </div>
        </header>
        <main class="main-content flex-grow flex flex-row overflow-hidden">
            <nav class="bg-gray-800 border-r border-gray-700 flex flex-col justify-start items-center p-2 space-y-4 w-[var(--sidebar-width)] flex-shrink-0"></nav>
            <div class="editor-panel-container h-full flex-grow">
                <div id="fileExplorerPanel" class="bg-gray-800 p-2 overflow-y-auto h-full w-full">
                    <div class="flex justify-end items-center mb-2 p-2 space-x-2">
                        <button id="uploadFileBtn" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-md" title="Upload File"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg></button>
                        <button id="newFileBtn" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-md" title="New File"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg></button>
                        <button id="newFolderBtn" class="p-2 bg-gray-700 hover:bg-gray-600 rounded-md" title="New Folder"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg></button>
                    </div>
                    <div id="fileTree"></div>
                </div>
                <div id="editorPanel" class="flex-col h-full w-full hidden"><div id="editorWrapper" class="flex-grow relative h-full"><textarea id="codeEditor"></textarea></div></div>
                <div id="previewPanel" class="bg-white h-full w-full hidden"><iframe id="previewFrame" class="w-full h-full border-none" sandbox="allow-scripts allow-same-origin"></iframe></div>
                <div id="assetsPanel" class="bg-gray-800 p-4 overflow-y-auto h-full w-full hidden flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Project Assets</h2>
                        <div class="flex space-x-2">
                            <button id="newAssetFolderBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">New Folder</button>
                            <button id="uploadAssetBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Upload</button>
                        </div>
                    </div>
                    <div id="assetList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>
                <div id="aiPanel" class="bg-gray-800 h-full w-full hidden flex flex-col">
                    <div class="p-4 flex justify-between items-center flex-shrink-0">
                        <h2 class="text-xl font-bold">AI Code Assistant</h2>
                        <button id="editorAiSettingsBtn" class="p-2 rounded-full hover:bg-gray-700" title="AI Settings">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        </button>
                    </div>
                    <div id="aiChatContainer" class="flex-grow overflow-y-auto mb-4 space-y-4 flex flex-col px-4"></div>
                    <div class="flex-shrink-0 space-y-2 px-4 pb-8">
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <button class="ai-action-btn bg-gray-700 hover:bg-gray-600 p-2 rounded-md" data-prompt="Explain the selected code.">Explain Code</button>
                            <button class="ai-action-btn bg-gray-700 hover:bg-gray-600 p-2 rounded-md" data-prompt="Find potential bugs in the selected code.">Find Bugs</button>
                            <button class="ai-action-btn bg-gray-700 hover:bg-gray-600 p-2 rounded-md" data-prompt="Optimize the selected code.">Optimize</button>
                            <button class="ai-action-btn bg-gray-700 hover:bg-gray-600 p-2 rounded-md" data-prompt="Add comments to the selected code.">Add Comments</button>
                        </div>
                        <div class="flex items-center">
                            <input type="text" id="aiInput" class="w-full bg-gray-700 border-gray-600 rounded-l-md p-3 text-white focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ask about your code...">
                            <button id="aiSendBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold p-3 rounded-r-md">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="searchPanel" class="bg-gray-800 p-4 h-full w-full hidden flex-col">
                    <h2 class="text-xl font-bold mb-4 flex-shrink-0">Project Search</h2>
                    <div class="flex items-center mb-4">
                        <input type="text" id="searchInput" class="w-full bg-gray-700 border-gray-600 rounded-l-md p-3 text-white focus:ring-indigo-500 focus:border-indigo-500" placeholder="Search across all files...">
                        <button id="searchBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold p-3 rounded-r-md">Search</button>
                    </div>
                    <div id="searchResults" class="flex-grow overflow-y-auto pr-2"></div>
                </div>
                 <div id="snippetsPanel" class="bg-gray-800 p-4 h-full w-full hidden flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Code Snippets</h2>
                        <button id="newSnippetBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">New Snippet</button>
                    </div>
                    <div id="snippetList" class="flex-grow overflow-y-auto pr-2 space-y-2"></div>
                </div>
                <div id="gitPanel" class="bg-gray-800 p-4 overflow-y-auto h-full w-full hidden flex-col">
                    <h2 class="text-xl font-bold mb-4 flex-shrink-0">Git Control</h2>
                    <div id="gitConnectView">
                        <h3 class="text-lg font-semibold mb-2">Connect to GitHub</h3>
                        <p class="text-sm text-gray-400 mb-4">Enter a <a href="https://github.com/settings/tokens/new?scopes=repo" target="_blank" class="text-indigo-400 hover:underline">Personal Access Token</a> to connect your account.</p>
                        <div class="space-y-4">
                            <div>
                                <label for="githubPat" class="block text-sm font-medium text-gray-300">Personal Access Token (PAT)</label>
                                <input type="password" id="githubPat" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md p-3 text-white focus:ring-indigo-500 focus:border-indigo-500" placeholder="ghp_...">
                            </div>
                            <button id="connectGitBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg">Connect</button>
                        </div>
                    </div>
                    <div id="gitMainView" class="hidden flex flex-col h-full">
                         <div class="flex justify-between items-center mb-4 flex-shrink-0">
                            <div class="flex items-center">
                                <img id="githubAvatar" class="h-10 w-10 rounded-full mr-3">
                                <div>
                                    <p class="font-semibold">Connected as</p>
                                    <p id="githubUsername" class="text-indigo-400"></p>
                                </div>
                            </div>
                            <button id="disconnectGitBtn" class="bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-2 px-4 rounded-lg">Disconnect</button>
                        </div>
                        <div class="mb-4 flex-shrink-0">
                            <label for="repoSelect" class="block text-sm font-medium text-gray-300">Repository</label>
                            <select id="repoSelect" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md p-2 text-white focus:ring-indigo-500 focus:border-indigo-500">
                                <option>Select a repository...</option>
                            </select>
                        </div>
                        <div id="gitActionButtons" class="mb-4 flex space-x-2">
                            <button id="pullBtn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded-lg">Pull</button>
                            <button id="pushBtn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded-lg">Push</button>
                        </div>
                        <div class="flex-grow overflow-y-auto space-y-4 pr-2">
                            <div>
                                <h4 class="text-sm font-bold uppercase text-gray-400 mb-2">Changes</h4>
                                <div id="gitChangesList" class="space-y-2"></div>
                            </div>
                             <div>
                                <h4 class="text-sm font-bold uppercase text-gray-400 mb-2">Staged Changes</h4>
                                <div id="gitStagedList" class="space-y-2"></div>
                            </div>
                             <div>
                                <h4 class="text-sm font-bold uppercase text-gray-400 mb-2">Commit History</h4>
                                <div id="commitHistory" class="space-y-2 text-gray-500 text-sm">
                                    <p>Commit history will appear here...</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 border-t border-gray-700 pt-4 flex-shrink-0">
                            <textarea id="commitMessage" class="w-full bg-gray-700 border-gray-600 rounded-md p-2 text-white mb-2" placeholder="Commit message..." rows="2"></textarea>
                            <button id="commitBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg">Commit</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="modalContainer" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"></div>
    <div id="contextMenu" class="context-menu glassmorphism hidden"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // PASTE YOUR NEW FIREBASE CONFIG OBJECT HERE
            const firebaseConfig = {
                apiKey: "AIzaSyD8Z_71XdH8iTn1bTgpau_VvakKAJugxtc",
                authDomain: "ma-gog.firebaseapp.com",
                projectId: "ma-gog",
                storageBucket: "ma-gog.appspot.com",
                messagingSenderId: "952701776950",
                appId: "1:952701776950:web:5bae36c33f0cfa9a07d497"
            };

            const DOM = {
                views: { 
                    auth: document.getElementById('authView'), 
                    home: document.getElementById('homeView'),
                    canvas: document.getElementById('canvasView'),
                    ai: document.getElementById('aiView'),
                    devSuite: document.getElementById('devSuiteView'),
                    dashboard: document.getElementById('dashboardView'), 
                    editor: document.getElementById('editorView') 
                },
                loginForm: document.getElementById('loginForm'),
                registerForm: document.getElementById('registerForm'),
                loginSwitch: document.getElementById('loginSwitch'),
                registerSwitch: document.getElementById('registerSwitch'),
                authMessageBox: document.getElementById('authMessageBox'),
                logoutBtn: document.getElementById('logoutBtn'),
                fileUploader: document.getElementById('fileUploader'),
                assetUploader: document.getElementById('assetUploader'),
                hub: {
                    editorBtn: document.getElementById('hubEditorBtn'),
                    devSuiteBtn: document.getElementById('hubDevSuiteBtn'),
                    gitBtn: document.getElementById('hubGitBtn'),
                    aiBtn: document.getElementById('hubAiBtn'),
                    canvasBtn: document.getElementById('hubCanvasBtn'),
                },
                canvasViewBackBtn: document.getElementById('canvasViewBackBtn'),
                aiViewBackBtn: document.getElementById('aiViewBackBtn'),
                devSuite: {
                    main: document.getElementById('devSuiteMain'),
                    backBtn: document.getElementById('devSuiteBackBtn'),
                    tabs: document.querySelectorAll('.devsuite-tab'),
                    panels: {
                        breakdown: document.getElementById('breakdownPanel'),
                        combine: document.getElementById('combinePanel'),
                        merge: document.getElementById('mergePanel')
                    },
                    breakdown: {
                        input: document.getElementById('breakdownInput'),
                        breakdownBtn: document.getElementById('breakdownBtn'),
                        outputContainer: document.getElementById('breakdownOutputContainer'),
                        htmlOutput: document.getElementById('htmlOutput'),
                        cssOutput: document.getElementById('cssOutput'),
                        jsOutput: document.getElementById('jsOutput'),
                        addToProjectBtn: document.getElementById('addToProjectBtn'),
                    },
                    combine: {
                        htmlInput: document.getElementById('combineHtmlInput'),
                        cssInput: document.getElementById('combineCssInput'),
                        jsInput: document.getElementById('combineJsInput'),
                        combineBtn: document.getElementById('combineBtn'),
                        outputContainer: document.getElementById('combineOutputContainer'),
                        combinedOutput: document.getElementById('combinedOutput'),
                    },
                    merge: {
                        currentInput: document.getElementById('mergeCurrentInput'),
                        newInput: document.getElementById('mergeNewInput'),
                        mergeBtn: document.getElementById('mergeBtn'),
                        outputContainer: document.getElementById('mergeOutputContainer'),
                        mergedOutput: document.getElementById('mergedOutput'),
                    }
                },
                dashboardBackBtn: document.getElementById('dashboardBackBtn'),
                projectList: document.getElementById('projectList'),
                newProjectBtn: document.getElementById('newProjectBtn'),
                backToProjectsBtn: document.getElementById('backToProjectsBtn'),
                fileTree: document.getElementById('fileTree'),
                saveButton: document.getElementById('saveButton'),
                previewFrame: document.getElementById('previewFrame'),
                sidebarNav: document.querySelector('#editorView nav'),
                modalContainer: document.getElementById('modalContainer'),
                contextMenu: document.getElementById('contextMenu'),
                headerTitle: document.querySelector('#editorView #headerTitle'),
                runButton: document.querySelector('#editorView #runButton'),
                uploadFileBtn: document.getElementById('uploadFileBtn'),
                newFileBtn: document.getElementById('newFileBtn'),
                newFolderBtn: document.getElementById('newFolderBtn'),
                editorPanels: {
                    fileExplorerPanel: document.getElementById('fileExplorerPanel'),
                    editorPanel: document.getElementById('editorPanel'),
                    previewPanel: document.getElementById('previewPanel'),
                    assetsPanel: document.getElementById('assetsPanel'),
                    aiPanel: document.getElementById('aiPanel'),
                    searchPanel: document.getElementById('searchPanel'),
                    snippetsPanel: document.getElementById('snippetsPanel'),
                    gitPanel: document.getElementById('gitPanel')
                },
                assets: {
                    uploadBtn: document.getElementById('uploadAssetBtn'),
                    newFolderBtn: document.getElementById('newAssetFolderBtn'),
                    list: document.getElementById('assetList'),
                },
                editorAi: {
                    chatContainer: document.getElementById('aiChatContainer'),
                    input: document.getElementById('aiInput'),
                    sendBtn: document.getElementById('aiSendBtn'),
                    actionBtns: document.querySelectorAll('#aiPanel .ai-action-btn'),
                    settingsBtn: document.getElementById('editorAiSettingsBtn'),
                },
                hubAi: {
                    chatContainer: document.getElementById('hubAiChatContainer'),
                    input: document.getElementById('hubAiInput'),
                    sendBtn: document.getElementById('hubAiSendBtn'),
                    settingsBtn: document.getElementById('hubAiSettingsBtn'),
                },
                canvasAi: {
                    chatContainer: document.getElementById('canvasAiChatContainer'),
                    input: document.getElementById('canvasAiInput'),
                    sendBtn: document.getElementById('canvasAiSendBtn'),
                    actionBtns: document.querySelectorAll('#canvasView .canvas-ai-action-btn'),
                    settingsBtn: document.getElementById('canvasAiSettingsBtn'),
                },
                search: {
                    input: document.getElementById('searchInput'),
                    btn: document.getElementById('searchBtn'),
                    results: document.getElementById('searchResults'),
                },
                snippets: {
                    newBtn: document.getElementById('newSnippetBtn'),
                    list: document.getElementById('snippetList'),
                },
                git: {
                    connectView: document.getElementById('gitConnectView'),
                    mainView: document.getElementById('gitMainView'),
                    patInput: document.getElementById('githubPat'),
                    connectBtn: document.getElementById('connectGitBtn'),
                    disconnectBtn: document.getElementById('disconnectGitBtn'),
                    avatar: document.getElementById('githubAvatar'),
                    username: document.getElementById('githubUsername'),
                    repoSelect: document.getElementById('repoSelect'),
                    changesList: document.getElementById('gitChangesList'),
                    stagedList: document.getElementById('gitStagedList'),
                    commitMessage: document.getElementById('commitMessage'),
                    commitBtn: document.getElementById('commitBtn'),
                    pushBtn: document.getElementById('pushBtn'),
                    pullBtn: document.getElementById('pullBtn'),
                    commitHistory: document.getElementById('commitHistory'),
                }
            };

            let auth, db, editor, canvasEditor;
            let userId, currentProjectId, activeFileId = null;
            let fileStructureUnsubscribe, projectsUnsubscribe, assetsUnsubscribe, snippetsUnsubscribe;
            let fileStructure = [];
            let devSuiteEditors = {};
            let devSuiteListenersAttached = false;
            let gitChangedFiles = [], gitStagedFiles = [];
            let devSuiteUploadTarget = null;
            let projectsListener = null;

            function showView(viewName) {
                Object.values(DOM.views).forEach(view => view.classList.remove('active'));
                DOM.views[viewName].classList.add('active');
                if (viewName === 'devSuite') {
                    initDevSuiteEditors();
                    setupDevSuiteListeners(); 
                    showDevSuiteTab('breakdown');
                }
                if (viewName === 'canvas') {
                    initCanvasEditor();
                }
            }

            function main() {
                try {
                    firebase.initializeApp(firebaseConfig);
                    auth = firebase.auth();
                    db = firebase.firestore();

                    auth.onAuthStateChanged(user => {
                        if (user) {
                            userId = user.uid;
                            showView('home');
                            if (projectsListener) projectsListener();
                            if (fileStructureUnsubscribe) fileStructureUnsubscribe();
                            if (assetsUnsubscribe) assetsUnsubscribe();
                            if (snippetsUnsubscribe) snippetsUnsubscribe();
                            listenForSnippets();
                            checkGitConnection();
                        } else {
                            userId = null;
                            showView('auth');
                            setupAuthForms();
                        }
                    });
                    DOM.hub.editorBtn.onclick = () => loadUserProjects();
                    DOM.hub.devSuiteBtn.onclick = () => showView('devSuite');
                    DOM.hub.gitBtn.onclick = () => {
                        loadUserProjects(true); 
                    };
                    DOM.hub.aiBtn.onclick = () => showView('ai');
                    DOM.hub.canvasBtn.onclick = () => showView('canvas');
                    DOM.canvasViewBackBtn.onclick = () => showView('home');
                    DOM.aiViewBackBtn.onclick = () => showView('home');
                    DOM.devSuite.backBtn.onclick = () => showView('home');
                    DOM.dashboardBackBtn.onclick = () => showView('home');
                    DOM.logoutBtn.onclick = () => auth.signOut();
                } catch (error) {
                    console.error("Firebase Init Error:", error);
                    document.body.innerHTML = `<div class="bg-gray-900 text-white h-screen flex items-center justify-center p-4"><div class="text-center"><h1 class="text-2xl font-bold text-red-500">Connection Error</h1><p class="mt-2 text-gray-400">Could not connect to the database. Please verify your Firebase config and security rules.</p></div></div>`;
                }
            }
            
            function setupAuthForms() {
                DOM.loginSwitch.onclick = () => {
                    DOM.loginSwitch.classList.add('active'); DOM.registerSwitch.classList.remove('active');
                    DOM.loginForm.style.display = 'block'; DOM.registerForm.style.display = 'none';
                    DOM.authMessageBox.textContent = '';
                };
                DOM.registerSwitch.onclick = () => {
                    DOM.registerSwitch.classList.add('active'); DOM.loginSwitch.classList.remove('active');
                    DOM.registerForm.style.display = 'block'; DOM.loginForm.style.display = 'none';
                    DOM.authMessageBox.textContent = '';
                };
                DOM.loginForm.onsubmit = async (e) => {
                    e.preventDefault();
                    try { await auth.signInWithEmailAndPassword(DOM.loginForm.loginEmail.value, DOM.loginForm.loginPassword.value); } 
                    catch (error) { DOM.authMessageBox.textContent = error.message; }
                };
                DOM.registerForm.onsubmit = async (e) => {
                    e.preventDefault();
                    try { await auth.createUserWithEmailAndPassword(DOM.registerForm.registerEmail.value, DOM.registerForm.registerPassword.value); }
                    catch (error) { DOM.authMessageBox.textContent = error.message; }
                };
            }
            
            async function loadUserProjects(openGitPanel = false) {
                showView('dashboard');
                const projectsRef = db.collection("users").doc(userId).collection("projects");
                
                if (projectsListener) projectsListener(); // Detach previous listener
                projectsListener = projectsRef.orderBy("lastModified", "desc").onSnapshot(snapshot => {
                    const projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (openGitPanel) {
                        if (projects.length > 0) {
                            selectProject(projects[0].id, projects[0].name, true);
                        } else {
                            DOM.projectList.innerHTML = `<div class="col-span-full text-center text-gray-500 mt-10"><p>Create a project first to use the GitHub integration.</p></div>`;
                        }
                    } else {
                        renderProjectList(projects);
                    }
                });
            }

            function renderProjectList(projects) {
                DOM.projectList.innerHTML = '';
                if (projects.length === 0) {
                    DOM.projectList.innerHTML = `<div class="col-span-full text-center text-gray-500 mt-10"><p>No projects yet. Click "New Project" to start.</p></div>`;
                } else {
                    projects.forEach(project => {
                        const card = document.createElement('div');
                        card.className = 'project-card bg-gray-800 rounded-lg p-4 flex flex-col justify-between border border-gray-700 hover:border-indigo-500';
                        card.innerHTML = `
                            <div>
                                <h3 class="text-xl font-bold truncate">${project.name}</h3>
                                <p class="text-gray-400 text-sm mt-2">Last modified: ${project.lastModified ? new Date(project.lastModified.toDate()).toLocaleDateString() : 'N/A'}</p>
                            </div>
                            <div class="mt-4 space-y-2">
                                <button class="open-project-btn w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg" data-project-id="${project.id}" data-project-name="${project.name}">Open</button>
                                <div class="flex space-x-2">
                                    <button class="rename-project-btn w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-2 rounded-lg text-sm" data-project-id="${project.id}" data-project-name="${project.name}">Rename</button>
                                    <button class="delete-project-btn w-full bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-2 rounded-lg text-sm" data-project-id="${project.id}" data-project-name="${project.name}">Delete</button>
                                </div>
                            </div>
                        `;
                        DOM.projectList.appendChild(card);
                    });
                }
            }

            function handleCreateProject() {
                const content = `<input type="text" id="modalInput" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white" placeholder="My Awesome Project">`;
                showModal('Create New Project', content, [
                    { text: 'Cancel', class: 'px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-sm', onClick: closeModal },
                    { text: 'Create', class: 'px-4 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 text-sm', onClick: async () => {
                        const name = document.getElementById('modalInput').value.trim();
                        if (!name) return;
                        const newProjectRef = await db.collection("users").doc(userId).collection("projects").add({ name, createdAt: firebase.firestore.FieldValue.serverTimestamp(), lastModified: firebase.firestore.FieldValue.serverTimestamp() });
                        await createDefaultProject(newProjectRef.id);
                        closeModal();
                        selectProject(newProjectRef.id, name);
                    }}
                ]);
            }
            
            function showModal(title, content, buttons) {
                DOM.modalContainer.innerHTML = `<div class="p-6 rounded-lg shadow-xl w-11/12 max-w-md glassmorphism"><h3 class="text-lg font-medium mb-4">${title}</h3><div>${content}</div><div class="mt-6 flex justify-end space-x-3">${buttons.map((b, i) => `<button id="modal-btn-${i}" class="${b.class}">${b.text}</button>`).join('')}</div></div>`;
                DOM.modalContainer.classList.remove('hidden');
                buttons.forEach((b, i) => document.getElementById(`modal-btn-${i}`).onclick = b.onClick);
                const input = DOM.modalContainer.querySelector('input');
                if (input) input.focus();
            }

            function closeModal() {
                DOM.modalContainer.classList.add('hidden');
                DOM.modalContainer.innerHTML = '';
            }

            function initEditor() {
                if (editor) return;
                editor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
                    lineNumbers: true,
                    theme: 'material-darker',
                    mode: 'htmlmixed',
                    indentUnit: 2,
                    tabSize: 2,
                    lineWrapping: true,
                    autoCloseBrackets: true,
                    extraKeys: {"Ctrl-Space": "autocomplete"},
                    hintOptions: { completeSingle: false },
                    gutters: ["CodeMirror-linenumbers", "CodeMirror-lint-markers", "CodeMirror-foldgutter"],
                    lint: true,
                    foldGutter: true
                });
                
                editor.on("inputRead", function(cm, change) {
                    if (change.text[0] !== ';' && change.text[0] !== ' ') {
                       cm.showHint();
                    }
                });
            }

            function initCanvasEditor() {
                if (canvasEditor) {
                    setTimeout(() => canvasEditor.refresh(), 1);
                    return;
                }
                canvasEditor = CodeMirror.fromTextArea(document.getElementById('canvasEditor'), {
                    lineNumbers: true,
                    theme: 'material-darker',
                    mode: 'markdown',
                    lineWrapping: true,
                });
                 setTimeout(() => canvasEditor.refresh(), 1);
            }

            async function selectProject(projectId, projectName, openGitPanel = false) {
                currentProjectId = projectId;
                DOM.headerTitle.textContent = projectName;
                showView('editor');
                initEditor();
                setupSidebarNav();
                
                if (fileStructureUnsubscribe) fileStructureUnsubscribe();
                const filesRef = db.collection("projects").doc(projectId).collection("files");
                fileStructureUnsubscribe = filesRef.onSnapshot((snapshot) => {
                    fileStructure = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderFileTree();
                    if (openGitPanel) showPanel('gitPanel');
                });
                
                if (assetsUnsubscribe) assetsUnsubscribe();
                const assetsRef = db.collection("projects").doc(projectId).collection("assets");
                assetsUnsubscribe = assetsRef.orderBy("uploadedAt", "desc").onSnapshot((snapshot) => {
                    const assets = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderAssets(assets);
                });
            }

            async function createDefaultProject(projectId) {
                const batch = db.batch();
                const filesRef = db.collection("projects").doc(projectId).collection("files");
                const projectDoc = await db.collection('users').doc(userId).collection('projects').doc(projectId).get();
                const projectName = projectDoc.exists ? projectDoc.data().name : 'My Project';
                batch.set(filesRef.doc(), { name: 'index.html', type: 'file', parentId: 'root', content: `<!DOCTYPE html>\n<html>\n<head>\n  <title>${projectName}</title>\n  <link rel="stylesheet" href="style.css">\n</head>\n<body>\n  <h1>Hello, ${projectName}!</h1>\n  <script src="script.js"><\/script>\n</body>\n</html>` });
                batch.set(filesRef.doc(), { name: 'script.js', type: 'file', parentId: 'root', content: `console.log("Hello from ${projectName}!");` });
                batch.set(filesRef.doc(), { name: 'style.css', type: 'file', parentId: 'root', content: `body { font-family: sans-serif; }` });
                await batch.commit();
            }

            function setupSidebarNav() {
                const navItems = [
                    { id: 'fileExplorerPanel', icon: 'M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z', label: 'Files' }, 
                    { id: 'searchPanel', icon: 'M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z', label: 'Search'},
                    { id: 'editorPanel', icon: 'M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4', label: 'Editor' }, 
                    { id: 'assetsPanel', icon: 'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1-1a2 2 0 01-2.828 0L8 12m0 0l-4 4m4-4V4m12 12v-4m0 4h-4m4 0l-4-4', label: 'Assets'},
                    { id: 'snippetsPanel', icon: 'M13 10V3L4 14h7v7l9-11h-7z', label: 'Snippets'},
                    { id: 'aiPanel', icon: 'M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z', label: 'AI'},
                    { id: 'previewPanel', icon: 'M15 12a3 3 0 11-6 0 3 3 0 016 0zM2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z', label: 'Preview' },
                    { id: 'gitPanel', icon: 'M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0zM9 11a1 1 0 100-2 1 1 0 000 2z', label: 'Git' }
                ];
                DOM.sidebarNav.innerHTML = navItems.map(item => `<button data-panel="${item.id}" class="sidebar-btn w-full flex flex-col items-center justify-center p-2 text-gray-400 rounded-lg hover:bg-gray-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${item.icon}" /></svg><span class="text-xs">${item.label}</span></button>`).join('');
                document.querySelectorAll('.sidebar-btn').forEach(btn => btn.addEventListener('click', () => showPanel(btn.dataset.panel)));
                showPanel('fileExplorerPanel');
            }

            function showPanel(panelId) {
                Object.values(DOM.editorPanels).forEach(p => p.classList.add('hidden'));
                DOM.editorPanels[panelId].classList.remove('hidden');
                DOM.editorPanels[panelId].classList.add('flex'); // Ensure flex is active for panels
                document.querySelectorAll('.sidebar-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.panel === panelId));
                
                if (panelId === 'editorPanel' && editor) setTimeout(() => editor.refresh(), 1);
                if (panelId === 'previewPanel') runProject();
            }

            function renderFileTree() {
                DOM.fileTree.innerHTML = '';
                DOM.fileTree.appendChild(createTreeElement(buildTree(fileStructure, 'root')));
            }

            function buildTree(list, parentId) {
                const tree = [];
                list.filter(item => item.parentId === parentId).forEach(item => tree.push({ ...item, children: buildTree(list, item.id) }));
                return tree.sort((a, b) => (a.type === 'folder' && b.type === 'file') ? -1 : (a.type === 'file' && b.type === 'folder') ? 1 : a.name.localeCompare(b.name));
            }

            function createTreeElement(nodes) {
                const ul = document.createElement('ul');
                if (nodes.length === 0 && document.getElementById('fileTree').children.length === 0) {
                     ul.innerHTML = `<li class="text-gray-500 text-sm p-2">Project is empty</li>`;
                }
                nodes.forEach(node => {
                    const li = document.createElement('li');
                    const isFolder = node.type === 'folder';
                    
                    const itemContainer = document.createElement('div');
                    itemContainer.className = `${isFolder ? 'folder-item-container' : 'file-item-container'} flex items-center p-2 rounded-md`;
                    
                    const mainContent = document.createElement('div');
                    mainContent.className = 'flex-grow flex items-center cursor-pointer truncate';
                    
                    let iconHTML = isFolder ? `<svg class="h-5 w-5 mr-1 flex-shrink-0 text-gray-500 folder-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 flex-shrink-0 text-yellow-500" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" /></svg>` 
                                         : `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 flex-shrink-0 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>`;
                    mainContent.innerHTML = `${iconHTML}<span class="truncate">${node.name}</span>`;
                    
                    const menuButton = document.createElement('button');
                    menuButton.className = 'item-menu-btn p-1 rounded-full flex-shrink-0';
                    menuButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" /></svg>`;
                    
                    itemContainer.append(mainContent, menuButton);
                    li.appendChild(itemContainer);

                    mainContent.onclick = () => {
                        document.querySelectorAll('.file-item-container, .folder-item-container').forEach(el => el.classList.remove('selected'));
                        itemContainer.classList.add('selected');
                        if (isFolder) {
                            const folderContentDiv = li.querySelector('.folder-content');
                            const arrow = mainContent.querySelector('.folder-arrow');
                            folderContentDiv.classList.toggle('hidden');
                            arrow.classList.toggle('rotate-90');
                        } else { openFile(node.id); }
                    };

                    menuButton.onclick = (e) => {
                        e.stopPropagation();
                        const rect = e.currentTarget.getBoundingClientRect();
                        showContextMenu(rect.left, rect.bottom, node.id, node.name, node.type);
                    };

                    if (isFolder) {
                        const folderContentDiv = document.createElement('div');
                        folderContentDiv.className = 'folder-content hidden';
                        if (node.children.length > 0) {
                            folderContentDiv.appendChild(createTreeElement(node.children));
                        }
                        li.appendChild(folderContentDiv);
                    }
                    ul.appendChild(li);
                });
                return ul;
            }
            
            function openFile(fileId, line = 0, ch = 0) {
                activeFileId = fileId;
                const file = fileStructure.find(f => f.id === fileId);
                if (!file) { editor.setValue('// File not found.'); return; }
                const fileExtension = file.name.split('.').pop();
                let mode = 'text/plain';
                if (fileExtension === 'html') mode = 'htmlmixed';
                else if (fileExtension === 'css') mode = 'css';
                else if (fileExtension === 'js') mode = 'javascript';

                editor.setValue(file.content || '');
                editor.setOption('mode', mode);
                editor.setCursor({line, ch});
                editor.focus();
                showPanel('editorPanel');
            }

            async function saveData() {
                if (!currentProjectId || !activeFileId) return;
                const fileContent = editor.getValue();
                if (fileContent.length > 1048576) {
                    alert('Error: File is too large to save. Firestore documents have a 1MB limit.');
                    return;
                }
                DOM.saveButton.disabled = true; DOM.saveButton.textContent = 'Saving...';
                try {
                    const fileRef = db.collection("projects").doc(currentProjectId).collection("files").doc(activeFileId);
                    await fileRef.update({ content: fileContent });
                    await db.collection("users").doc(userId).collection("projects").doc(currentProjectId).update({ lastModified: firebase.firestore.FieldValue.serverTimestamp() });
                    DOM.saveButton.textContent = 'Saved!'; DOM.saveButton.classList.add('bg-green-600');
                    setTimeout(() => { DOM.saveButton.textContent = 'Save'; DOM.saveButton.classList.remove('bg-green-600'); DOM.saveButton.disabled = false; }, 2000);
                } catch (error) {
                    console.error("Save Error:", error);
                    DOM.saveButton.textContent = 'Save'; DOM.saveButton.disabled = false;
                }
            }
            
            function runProject() {
                const htmlFile = fileStructure.find(f => f.name === 'index.html');
                if (!htmlFile) {
                    DOM.previewFrame.srcdoc = `<html><body><h1 style="font-family: sans-serif; color: red;">Error: index.html not found!</h1></body></html>`;
                    return;
                }
                
                let htmlContent = htmlFile.content;
                const cssLinks = htmlContent.match(/<link.*?href="(.*?\.css)".*?>/g) || [];
                cssLinks.forEach(link => {
                    const href = link.match(/href="(.*?)"/)[1];
                    const cssFile = fileStructure.find(f => f.name === href);
                    if (cssFile) htmlContent = htmlContent.replace(link, `<style>${cssFile.content}</style>`);
                });

                const scriptSrcs = htmlContent.match(/<script.*?src="(.*?)"><\/script>/g) || [];
                scriptSrcs.forEach(scriptTag => {
                    const src = scriptTag.match(/src="(.*?)"/)[1];
                    const jsFile = fileStructure.find(f => f.name === src);
                    if (jsFile) htmlContent = htmlContent.replace(scriptTag, `<script>${jsFile.content}<\/script>`);
                });

                DOM.previewFrame.srcdoc = htmlContent;
                showPanel('previewPanel');
            }

            function showContextMenu(x, y, id, name, type) {
                hideContextMenu();
                let menuItems = '';
                if (type === 'folder') {
                    menuItems += `<div class="context-menu-item" data-action="newFile"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>New File</div>`;
                    menuItems += `<div class="context-menu-item" data-action="newFolder"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg>New Folder</div>`;
                    menuItems += `<div class="context-menu-divider"></div>`;
                }
                menuItems += `<div class="context-menu-item" data-action="rename"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z" /></svg>Rename</div>`;
                if (type === 'file') {
                     menuItems += `<div class="context-menu-item" data-action="download"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>Download</div>`;
                }
                menuItems += `<div class="context-menu-item delete" data-action="delete"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>Delete</div>`;
                
                DOM.contextMenu.innerHTML = menuItems;
                DOM.contextMenu.style.top = `0px`; DOM.contextMenu.style.left = `0px`;
                DOM.contextMenu.classList.remove('hidden');

                const menuWidth = DOM.contextMenu.offsetWidth; const menuHeight = DOM.contextMenu.offsetHeight;
                let finalX = x - menuWidth; let finalY = y;
                if (finalX < 0) finalX = x;
                if (finalY + menuHeight > window.innerHeight) finalY = y - menuHeight;
                
                DOM.contextMenu.style.left = `${finalX}px`; DOM.contextMenu.style.top = `${finalY}px`;
                
                DOM.contextMenu.querySelector('[data-action="rename"]').onclick = () => { hideContextMenu(); handleRename(id, name); };
                DOM.contextMenu.querySelector('[data-action="delete"]').onclick = () => { hideContextMenu(); handleDelete(id, name, type); };
                if (type === 'file') {
                    DOM.contextMenu.querySelector('[data-action="download"]').onclick = () => { hideContextMenu(); handleDownload(id); };
                }
                if (type === 'folder') {
                    DOM.contextMenu.querySelector('[data-action="newFile"]').onclick = () => { hideContextMenu(); handleNewFile(id); };
                    DOM.contextMenu.querySelector('[data-action="newFolder"]').onclick = () => { hideContextMenu(); handleNewFolder(id); };
                }
            }

            function hideContextMenu() { DOM.contextMenu.classList.add('hidden'); }

            function handleNewFile(parentId = 'root') {
                const content = `<input type="text" id="modalInput" class="w-full bg-gray-700 border-gray-600 rounded-md px-3 py-2 text-white" placeholder="e.g., app.js">`;
                showModal('Create New File', content, [
                    { text: 'Cancel', class: 'px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-sm', onClick: closeModal },
                    { text: 'Create', class: 'px-4 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 text-sm', onClick: async () => {
                        const name = document.getElementById('modalInput').value.trim();
                        if (name) await db.collection("projects").doc(currentProjectId).collection("files").add({ name, type: 'file', parentId: parentId, content: '' });
                        closeModal();
                    }}
                ]);
            }

            function handleNewFolder(parentId = 'root') {
                const content = `<input type="text" id="modalInput" class="w-full bg-gray-700 border-gray-600 rounded-md px-3 py-2 text-white" placeholder="e.g., components">`;
                showModal('Create New Folder', content, [
                    { text: 'Cancel', class: 'px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-sm', onClick: closeModal },
                    { text: 'Create', class: 'px-4 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 text-sm', onClick: async () => {
                        const name = document.getElementById('modalInput').value.trim();
                        if (name) await db.collection("projects").doc(currentProjectId).collection("files").add({ name, type: 'folder', parentId: parentId });
                        closeModal();
                    }}
                ]);
            }

            function handleRename(id, oldName) {
                const content = `<input type="text" id="modalInput" value="${oldName}" class="w-full bg-gray-700 border-gray-600 rounded-md px-3 py-2 text-white">`;
                showModal(`Rename "${oldName}"`, content, [
                    { text: 'Cancel', class: 'px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-sm', onClick: closeModal },
                    { text: 'Rename', class: 'px-4 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 text-sm', onClick: async () => {
                        const newName = document.getElementById('modalInput').value.trim();
                        if (newName && newName !== oldName) await db.collection("projects").doc(currentProjectId).collection("files").doc(id).update({ name: newName });
                        closeModal();
                    }}
                ]);
            }

            function handleDelete(id, name, type) {
                const content = `<p>Are you sure you want to delete <strong class="font-bold">${name}</strong>? This cannot be undone.</p>`;
                showModal(`Delete ${type}`, content, [
                    { text: 'Cancel', class: 'px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-sm', onClick: closeModal },
                    { text: 'Delete', class: 'px-4 py-2 rounded-md bg-red-600 hover:bg-red-700 text-sm', onClick: async () => {
                        await deleteItem(id, type);
                        closeModal();
                    }}
                ]);
            }
            
            async function deleteItem(itemId, itemType) {
                const batch = db.batch();
                const filesRef = db.collection("projects").doc(currentProjectId).collection("files");
                if (itemType === 'folder') {
                    const descendants = getDescendants(itemId);
                    descendants.forEach(id => batch.delete(filesRef.doc(id)));
                }
                batch.delete(filesRef.doc(itemId));
                await batch.commit();
                if (activeFileId === itemId) { editor.setValue(''); activeFileId = null; }
            }
            
            function getDescendants(folderId) {
                let children = fileStructure.filter(item => item.parentId === folderId);
                let descendantIds = children.map(c => c.id);
                children.forEach(child => {
                    if (child.type === 'folder') descendantIds = descendantIds.concat(getDescendants(child.id));
                });
                return descendantIds;
            }

            function handleDownload(fileId) {
                const file = fileStructure.find(f => f.id === fileId);
                if (!file) return;
                downloadFile(file.name, file.content);
            }
            
            function downloadFile(filename, content) {
                const mimeType = getMimeType(filename);
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = filename;
                document.body.appendChild(a); a.click();
                document.body.removeChild(a); URL.revokeObjectURL(url);
            }

            function getMimeType(filename) {
                const extension = filename.split('.').pop().toLowerCase();
                const mimeTypes = { html: 'text/html', css: 'text/css', js: 'application/javascript', json: 'application/json', png: 'image/png', jpg: 'image/jpeg', jpeg: 'image/jpeg' };
                return mimeTypes[extension] || 'application/octet-stream';
            }

            // --- DevSuite Logic ---
            function initDevSuiteEditors() {
                if (Object.keys(devSuiteEditors).length > 0) return;
                const editorOptions = { theme: 'material-darker', lineWrapping: true };
                devSuiteEditors.html = CodeMirror(DOM.devSuite.breakdown.htmlOutput, { ...editorOptions, mode: 'htmlmixed', readOnly: true });
                devSuiteEditors.css = CodeMirror(DOM.devSuite.breakdown.cssOutput, { ...editorOptions, mode: 'css', readOnly: true });
                devSuiteEditors.js = CodeMirror(DOM.devSuite.breakdown.jsOutput, { ...editorOptions, mode: 'javascript', readOnly: true });
                devSuiteEditors.combineHtml = CodeMirror(DOM.devSuite.combine.htmlInput, { ...editorOptions, mode: 'htmlmixed' });
                devSuiteEditors.combineCss = CodeMirror(DOM.devSuite.combine.cssInput, { ...editorOptions, mode: 'css' });
                devSuiteEditors.combineJs = CodeMirror(DOM.devSuite.combine.jsInput, { ...editorOptions, mode: 'javascript' });
                devSuiteEditors.combined = CodeMirror(DOM.devSuite.combine.combinedOutput, { ...editorOptions, mode: 'htmlmixed', readOnly: true });
                devSuiteEditors.mergeCurrent = CodeMirror(DOM.devSuite.merge.currentInput, { ...editorOptions, mode: 'htmlmixed' });
                devSuiteEditors.mergeNew = CodeMirror(DOM.devSuite.merge.newInput, { ...editorOptions, mode: 'htmlmixed' });
                devSuiteEditors.merged = CodeMirror(DOM.devSuite.merge.mergedOutput, { ...editorOptions, mode: 'htmlmixed', readOnly: true });
            }
            
            function breakdownCode(combinedCode) {
                const styleMatch = combinedCode.match(/<style>([\s\S]*?)<\/style>/);
                const scriptMatch = combinedCode.match(/<script>([\s\S]*?)<\/script>/);
                const cssCode = styleMatch ? styleMatch[1].trim() : '';
                const jsCode = scriptMatch ? scriptMatch[1].trim() : '';
                let htmlCode = combinedCode;
                if (styleMatch) htmlCode = htmlCode.replace(styleMatch[0], '');
                if (scriptMatch) htmlCode = htmlCode.replace(scriptMatch[0], '');
                return { html: htmlCode.trim(), css: cssCode, js: jsCode };
            }

            function handleBreakdown() {
                const combinedCode = DOM.devSuite.breakdown.input.value;
                if (!combinedCode.trim()) { alert("Please paste some code first."); return; }
                const { html, css, js } = breakdownCode(combinedCode);
                devSuiteEditors.html.setValue(html || '<!-- No HTML found -->');
                devSuiteEditors.css.setValue(css || '/* No CSS found */');
                devSuiteEditors.js.setValue(js || '// No JavaScript found');
                DOM.devSuite.breakdown.outputContainer.classList.remove('hidden');
                setTimeout(() => Object.values(devSuiteEditors).forEach(editor => editor.refresh()), 1);
            }
            
            function handleCombine() {
                const htmlCode = devSuiteEditors.combineHtml.getValue().trim();
                const cssCode = devSuiteEditors.combineCss.getValue().trim();
                const jsCode = devSuiteEditors.combineJs.getValue().trim();
                if (!htmlCode) { alert("HTML code is required to combine."); return; }
                let combined = htmlCode;
                if (cssCode) combined = combined.replace('</head>', `    <style>\n${cssCode}\n</style>\n</head>`);
                if (jsCode) combined = combined.replace('</body>', `    <script>\n${jsCode}\n<\/script>\n</body>`);
                devSuiteEditors.combined.setValue(combined);
                DOM.devSuite.combine.outputContainer.classList.remove('hidden');
                setTimeout(() => devSuiteEditors.combined.refresh(), 1);
            }
            
            function handleMerge() {
                const currentCode = devSuiteEditors.mergeCurrent.getValue();
                const newCode = devSuiteEditors.mergeNew.getValue();
                if (!currentCode.trim() || !newCode.trim()) { alert("Please provide both current and new code."); return; }

                const currentParts = breakdownCode(currentCode);
                const newParts = breakdownCode(newCode);

                const mergedCss = `${currentParts.css}\n\n/* --- New CSS --- */\n${newParts.css}`;
                const mergedJs = `${currentParts.js}\n\n// --- New JS ---\n${newParts.js}`;
                const mergedHtml = currentParts.html.replace('</body>', `\n\n<!-- --- New HTML --- -->\n${newParts.html}\n</body>`);

                let finalCode = mergedHtml;
                if (mergedCss.trim()) finalCode = finalCode.replace('</head>', `    <style>\n${mergedCss}\n</style>\n</head>`);
                if (mergedJs.trim()) finalCode = finalCode.replace('</body>', `    <script>\n${mergedJs}\n<\/script>\n</body>`);

                devSuiteEditors.merged.setValue(finalCode);
                DOM.devSuite.merge.outputContainer.classList.remove('hidden');
                setTimeout(() => devSuiteEditors.merged.refresh(), 1);
            }

            async function handleAddToProject() {
                const projectsRef = db.collection("users").doc(userId).collection("projects");
                const snapshot = await projectsRef.get();
                const projects = snapshot.docs.map(doc => ({ id: doc.id, name: doc.data().name }));

                if (projects.length === 0) {
                    alert("You don't have any projects. Please create one from the Code Editor section first.");
                    return;
                }

                const content = `
                    <label for="projectSelect" class="block text-sm font-medium text-gray-300 mb-2">Select a project:</label>
                    <select id="projectSelect" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white">
                        ${projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                    </select>`;
                
                showModal('Add to Project', content, [
                    { text: 'Cancel', class: 'px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-sm', onClick: closeModal },
                    { text: 'Add Files', class: 'px-4 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 text-sm', onClick: async () => {
                        const selectedProjectId = document.getElementById('projectSelect').value;
                        const batch = db.batch();
                        const filesRef = db.collection("projects").doc(selectedProjectId).collection("files");
                        
                        batch.set(filesRef.doc(), { name: 'index.html', type: 'file', parentId: 'root', content: devSuiteEditors.html.getValue() });
                        batch.set(filesRef.doc(), { name: 'style.css', type: 'file', parentId: 'root', content: devSuiteEditors.css.getValue() });
                        batch.set(filesRef.doc(), { name: 'script.js', type: 'file', parentId: 'root', content: devSuiteEditors.js.getValue() });

                        await batch.commit();
                        alert("Files added to project successfully!");
                        closeModal();
                    }}
                ]);
            }
            
            function showDevSuiteTab(tabName) {
                Object.values(DOM.devSuite.panels).forEach(p => p.classList.remove('active'));
                DOM.devSuite.tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
                DOM.devSuite.panels[tabName].classList.add('active');
                setTimeout(() => Object.values(devSuiteEditors).forEach(editor => editor.refresh()), 1);
            }

            function setupDevSuiteListeners() {
                if (devSuiteListenersAttached) return;

                DOM.devSuite.tabs.forEach(tab => {
                    tab.onclick = () => showDevSuiteTab(tab.dataset.tab);
                });

                DOM.devSuite.breakdown.breakdownBtn.onclick = handleBreakdown;
                DOM.devSuite.breakdown.addToProjectBtn.onclick = handleAddToProject;
                DOM.devSuite.combine.combineBtn.onclick = handleCombine;
                DOM.devSuite.merge.mergeBtn.onclick = handleMerge;
                
                DOM.devSuite.main.addEventListener('click', (e) => {
                    const copyBtn = e.target.closest('.copy-btn');
                    const downloadBtn = e.target.closest('.download-btn');

                    if (copyBtn) {
                        const target = copyBtn.dataset.target;
                        const editorInstance = devSuiteEditors[target];
                        const textToCopy = editorInstance.getValue();
                        
                        const textArea = document.createElement('textarea');
                        textArea.value = textToCopy;
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            copyBtn.textContent = 'Copied!';
                            setTimeout(() => { copyBtn.textContent = 'Copy'; }, 2000);
                        } catch (err) {
                            console.error('Fallback: Oops, unable to copy', err);
                            alert('Could not copy text.');
                        }
                        document.body.removeChild(textArea);
                    }

                    if (downloadBtn) {
                        const target = downloadBtn.dataset.target;
                        const isCombined = target === 'combined';
                        const isMerged = target === 'merged';
                        const editorInstance = devSuiteEditors[target];
                        const content = editorInstance.getValue();
                        let filename = `output.${target}`;
                        if(isCombined || isMerged) filename = `${target}.html`;
                        downloadFile(filename, content);
                    }
                });
                devSuiteListenersAttached = true;
            }

            // --- Git Logic ---
            async function checkGitConnection() {
                const userDoc = await db.collection('users').doc(userId).get();
                const userData = userDoc.data();
                if (userData && userData.githubToken) {
                    const token = userData.githubToken;
                    const userInfo = await verifyGitHubToken(token);
                    if (userInfo) {
                        showGitMainView(userInfo);
                    } else {
                        await disconnectFromGit();
                    }
                } else {
                    showGitConnectView();
                }
            }
            
            async function connectToGit() {
                const token = DOM.git.patInput.value.trim();
                if (!token) {
                    alert('Please enter a Personal Access Token.');
                    return;
                }
                const btn = DOM.git.connectBtn;
                btn.disabled = true;
                btn.textContent = 'Connecting...';

                const userInfo = await verifyGitHubToken(token);
                if (userInfo) {
                    await db.collection('users').doc(userId).set({ githubToken: token }, { merge: true });
                    showGitMainView(userInfo);
                    DOM.git.patInput.value = '';
                } else {
                    alert('Invalid or expired token. Please check your token and try again.');
                }
                btn.disabled = false;
                btn.textContent = 'Connect';
            }
            
            async function verifyGitHubToken(token) {
                try {
                    const response = await fetch('https://api.github.com/user', {
                        headers: { 'Authorization': `token ${token}` }
                    });
                    if (response.ok) {
                        return await response.json();
                    }
                    return null;
                } catch (error) {
                    console.error('Error verifying GitHub token:', error);
                    return null;
                }
            }

            async function disconnectFromGit() {
                await db.collection('users').doc(userId).update({ 
                    githubToken: firebase.firestore.FieldValue.delete() 
                });
                showGitConnectView();
            }

            function showGitConnectView() {
                DOM.git.connectView.classList.remove('hidden');
                DOM.git.mainView.classList.add('hidden');
            }

            function showGitMainView(userInfo) {
                DOM.git.avatar.src = userInfo.avatar_url;
                DOM.git.username.textContent = userInfo.login;
                DOM.git.connectView.classList.add('hidden');
                DOM.git.mainView.classList.remove('hidden');
                getGitStatus();
            }

            function getGitStatus() {
                // SIMULATION
                gitChangedFiles = [
                    { name: 'index.html', status: 'M' },
                    { name: 'style.css', status: 'M' },
                ];
                gitStagedFiles = [
                    { name: 'script.js', status: 'A' }
                ];
                renderGitStatus();
            }

            function renderGitStatus() {
                DOM.git.changesList.innerHTML = gitChangedFiles.length > 0 ? gitChangedFiles.map(file => `
                    <div class="git-file-item">
                        <span>${file.name}</span>
                        <div class="flex items-center space-x-2">
                            <span class="text-yellow-400 font-bold">${file.status}</span>
                            <button title="Stage Change" class="git-action-btn stage-btn" data-filename="${file.name}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    </div>
                `).join('') : `<p class="text-gray-500 text-sm">No changes.</p>`;
                
                DOM.git.stagedList.innerHTML = gitStagedFiles.length > 0 ? gitStagedFiles.map(file => `
                     <div class="git-file-item">
                        <span>${file.name}</span>
                        <div class="flex items-center space-x-2">
                            <span class="text-green-400 font-bold">${file.status}</span>
                            <button title="Unstage Change" class="git-action-btn unstage-btn" data-filename="${file.name}">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    </div>
                `).join('') : `<p class="text-gray-500 text-sm">No staged changes.</p>`;
            }

            function stageFile(filename) {
                const fileIndex = gitChangedFiles.findIndex(f => f.name === filename);
                if (fileIndex > -1) {
                    const [fileToStage] = gitChangedFiles.splice(fileIndex, 1);
                    gitStagedFiles.push(fileToStage);
                    renderGitStatus();
                }
            }

            function unstageFile(filename) {
                const fileIndex = gitStagedFiles.findIndex(f => f.name === filename);
                if (fileIndex > -1) {
                    const [fileToUnstage] = gitStagedFiles.splice(fileIndex, 1);
                    gitChangedFiles.push(fileToUnstage);
                    renderGitStatus();
                }
            }
            
            function handleCommit() {
                const message = DOM.git.commitMessage.value.trim();
                if (!message) {
                    alert('Please enter a commit message.');
                    return;
                }
                if (gitStagedFiles.length === 0) {
                    alert('There are no changes staged for commit.');
                    return;
                }
                
                console.log(`Committing ${gitStagedFiles.length} files with message: "${message}"`);
                alert(`Commit successful!\n\nMessage: "${message}"`);
                
                gitStagedFiles = [];
                DOM.git.commitMessage.value = '';
                renderGitStatus();
                DOM.git.commitHistory.innerHTML = `<p class="text-gray-400">Successfully committed "${message}"</p>` + DOM.git.commitHistory.innerHTML;
            }
            
            // --- Asset Management ---
            function renderAssets(assets) {
                 DOM.assets.list.innerHTML = assets.length > 0 ? assets.map(asset => {
                    const isSvg = asset.name.endsWith('.svg');
                    return `
                    <div class="relative group aspect-square flex flex-col items-center justify-center bg-gray-700 rounded-lg p-2 overflow-hidden">
                        ${isSvg ? 
                            `<div class="asset-svg-wrapper">${asset.content}</div>` :
                            `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                             <p class="text-xs text-gray-300 truncate w-full text-center mt-2 absolute bottom-2 px-1">${asset.name}</p>`
                        }
                        <div class="absolute inset-0 bg-black bg-opacity-60 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="copy-asset-content-btn text-white bg-indigo-600 px-3 py-1 rounded-md text-sm" data-content="${encodeURIComponent(asset.content)}">Copy Content</button>
                        </div>
                        <button class="delete-asset-btn" data-asset-id="${asset.id}" data-asset-name="${asset.name}" title="Delete Asset">
                            <svg class="w-5 h-5 text-white pointer-events-none" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                `}).join('') : `<p class="text-gray-500 text-sm col-span-full text-center">No assets uploaded yet.</p>`;
            }

            async function handleAssetUpload(e) {
                const file = e.target.files[0];
                if (!file || !currentProjectId) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    const content = event.target.result;
                    try {
                        await db.collection("projects").doc(currentProjectId).collection("assets").add({
                            name: file.name,
                            type: file.type || 'application/octet-stream',
                            content: content,
                            uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } catch (error) {
                        console.error("Asset upload error:", error);
                        alert("Error uploading asset to Firestore. Check console for details.");
                    }
                };
                reader.onerror = (error) => {
                    console.error("File reading error:", error);
                    alert("Could not read the selected file.");
                };
                reader.readAsText(file);
                DOM.assetUploader.value = ''; // Reset input
            }
            
            function handleDeleteAsset(assetId, assetName) {
                const content = `<p>Are you sure you want to delete asset <strong class="font-bold">${assetName}</strong>? This cannot be undone.</p>`;
                showModal('Delete Asset', content, [
                    { text: 'Cancel', class: 'px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-sm', onClick: closeModal },
                    { text: 'Delete', class: 'px-4 py-2 rounded-md bg-red-600 hover:bg-red-700 text-sm', onClick: async () => {
                        await db.collection("projects").doc(currentProjectId).collection("assets").doc(assetId).delete();
                        closeModal();
                    }}
                ]);
            }

            // --- AI Assistants ---
            function showApiKeyModal() {
                const content = `
                    <p class="text-gray-400 text-sm mb-4">To use the AI features on a hosted site, please provide your Google AI Studio API key. This key is stored only in your browser's local storage.</p>
                    <div>
                        <label for="apiKeyInput" class="block text-sm font-medium text-gray-300">Gemini API Key</label>
                        <input type="password" id="apiKeyInput" class="mt-1 block w-full bg-gray-900 border-gray-600 rounded-md p-2 text-white" placeholder="Enter your key...">
                    </div>
                    <p class="text-xs text-gray-500 mt-2">You can get a key from <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-indigo-400 hover:underline">Google AI Studio</a>.</p>
                `;
                showModal('AI Assistant Setup', content, [
                    { text: 'Cancel', class: 'px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-sm', onClick: closeModal },
                    { text: 'Save Key', class: 'px-4 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 text-sm', onClick: () => {
                        const key = document.getElementById('apiKeyInput').value.trim();
                        if (key) {
                            localStorage.setItem('geminiApiKey', key);
                            alert('API Key saved successfully!');
                            closeModal();
                        } else {
                            alert('Please enter a valid API key.');
                        }
                    }}
                ]);
            }

            function getApiKey() {
                const key = localStorage.getItem('geminiApiKey');
                if (!key) {
                    showApiKeyModal();
                    return null;
                }
                return key;
            }

            async function handleAIAssist(prompt, context, chatContainer, loadingId) {
                const apiKey = getApiKey();
                if (!apiKey) {
                    addMessageToAIChat('Please set your API key in the AI settings to use this feature.', 'assistant', chatContainer);
                    return;
                }
                
                if (!prompt.trim()) return;
                const fullPrompt = `${context}\n\nPlease help me with the following request: ${prompt}`;
                
                addMessageToAIChat(prompt, 'user', chatContainer);
                addMessageToAIChat('...', 'assistant', chatContainer, true, loadingId);

                try {
                    let chatHistory = [{ role: "user", parts: [{ text: fullPrompt }] }];
                    const payload = { contents: chatHistory };
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API error: ${response.statusText}`);

                    const result = await response.json();
                    if (!result.candidates || !result.candidates[0].content.parts[0].text) {
                         throw new Error("Invalid API response structure");
                    }
                    const text = result.candidates[0].content.parts[0].text;
                    
                    updateLastAIChatMessage(text, loadingId);

                } catch (error) {
                    console.error("AI Assistant Error:", error);
                    updateLastAIChatMessage(`Sorry, I encountered an error. Please check the console for details. Error: ${error.message}`, loadingId);
                }
            }

            function addMessageToAIChat(content, role, container, isLoading = false, loadingId) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `ai-message ${role}`;
                if (isLoading) {
                    messageDiv.id = loadingId;
                    messageDiv.innerHTML = `<div class="animate-pulse">  </div>`;
                } else {
                    content = content.replace(/```(\w+)?\n([\s\S]+?)```/g, '<pre class="bg-gray-900 p-2 rounded-md my-2"><code>$2</code></pre>');
                    messageDiv.innerHTML = content;
                }
                container.appendChild(messageDiv);
                container.scrollTop = container.scrollHeight;
            }
            
            function updateLastAIChatMessage(content, loadingId) {
                const loadingIndicator = document.getElementById(loadingId);
                if (loadingIndicator) {
                    content = content.replace(/```(\w+)?\n([\s\S]+?)```/g, '<pre class="bg-gray-900 p-2 rounded-md my-2"><code>$2</code></pre>');
                    loadingIndicator.innerHTML = content;
                    loadingIndicator.removeAttribute('id');
                }
            }
            
            // --- Project Search ---
            function handleProjectSearch() {
                const query = DOM.search.input.value.trim().toLowerCase();
                if (!query) {
                    DOM.search.results.innerHTML = '';
                    return;
                }
                
                let resultsHTML = '';
                let resultCount = 0;

                fileStructure.filter(f => f.type === 'file' && f.content).forEach(file => {
                    const lines = file.content.split('\n');
                    let fileResultsHTML = '';
                    
                    lines.forEach((line, index) => {
                        if (line.toLowerCase().includes(query)) {
                            resultCount++;
                            const highlightedLine = line.replace(new RegExp(query, 'gi'), `<span class="match">${query}</span>`);
                            fileResultsHTML += `
                                <div class="search-result-item p-2 rounded-md" data-fileid="${file.id}" data-line="${index}">
                                    <span class="text-gray-500 mr-2">${index + 1}:</span>
                                    <span class="font-mono text-sm">${highlightedLine.trim()}</span>
                                </div>
                            `;
                        }
                    });

                    if (fileResultsHTML) {
                        resultsHTML += `
                            <div class="mb-4">
                                <h4 class="font-bold text-indigo-400">${file.name}</h4>
                                ${fileResultsHTML}
                            </div>
                        `;
                    }
                });

                if (resultCount === 0) {
                    resultsHTML = `<p class="text-gray-500">No results found for "${DOM.search.input.value}".</p>`;
                }
                
                DOM.search.results.innerHTML = resultsHTML;
            }

            // --- Snippets ---
            function listenForSnippets() {
                if (snippetsUnsubscribe) snippetsUnsubscribe();
                const snippetsRef = db.collection("users").doc(userId).collection("snippets");
                snippetsUnsubscribe = snippetsRef.orderBy("name").onSnapshot(snapshot => {
                    const snippets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderSnippets(snippets);
                });
            }

            function renderSnippets(snippets) {
                DOM.snippets.list.innerHTML = snippets.length > 0 ? snippets.map(snippet => `
                    <div class="bg-gray-700 p-3 rounded-lg flex justify-between items-center">
                        <span class="font-mono text-indigo-400">${snippet.name}</span>
                        <button class="insert-snippet-btn bg-indigo-600 hover:bg-indigo-700 text-white text-xs px-3 py-1 rounded-md" data-id="${snippet.id}">Insert</button>
                    </div>
                `).join('') : `<p class="text-gray-500 text-sm text-center">No snippets saved yet.</p>`;
            }

            function handleCreateSnippet() {
                const content = `
                    <div class="space-y-4">
                        <div>
                            <label for="snippetName" class="block text-sm font-medium text-gray-300">Snippet Name</label>
                            <input type="text" id="snippetName" class="mt-1 block w-full bg-gray-900 border-gray-600 rounded-md p-2 text-white" placeholder="e.g., gameloop">
                        </div>
                        <div>
                            <label for="snippetCode" class="block text-sm font-medium text-gray-300">Snippet Code</label>
                            <textarea id="snippetCode" class="mt-1 block w-full bg-gray-900 border-gray-600 rounded-md p-2 text-white font-mono" rows="6"></textarea>
                        </div>
                    </div>`;
                showModal('Create New Snippet', content, [
                    { text: 'Cancel', class: 'px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-sm', onClick: closeModal },
                    { text: 'Save', class: 'px-4 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 text-sm', onClick: async () => {
                        const name = document.getElementById('snippetName').value.trim();
                        const code = document.getElementById('snippetCode').value.trim();
                        if (name && code) {
                            await db.collection("users").doc(userId).collection("snippets").add({ name, code });
                        }
                        closeModal();
                    }}
                ]);
            }
            
            async function insertSnippet(snippetId) {
                if (!editor) {
                    alert("Please open a file in the editor first.");
                    return;
                }
                const snippetDoc = await db.collection("users").doc(userId).collection("snippets").doc(snippetId).get();
                if (snippetDoc.exists) {
                    editor.replaceSelection(snippetDoc.data().code);
                    showPanel('editorPanel');
                }
            }
            
            // --- File Upload Handlers ---
            function handleFileUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    const content = event.target.result;
                    if (devSuiteUploadTarget) {
                        const targetEditor = devSuiteEditors[devSuiteUploadTarget] || (devSuiteUploadTarget === 'breakdownInput' && DOM.devSuite.breakdown.input);
                        if (targetEditor) {
                            if (targetEditor.setValue) targetEditor.setValue(content);
                            else targetEditor.value = content;
                        }
                        devSuiteUploadTarget = null;
                    } else {
                        await db.collection("projects").doc(currentProjectId).collection("files").add({
                            name: file.name,
                            type: 'file',
                            parentId: 'root', // Or implement folder selection
                            content: content
                        });
                    }
                };
                reader.readAsText(file);
                DOM.fileUploader.value = '';
            }

            // --- Project Management Handlers ---
            function handleRenameProject(projectId, oldName) {
                const content = `<input type="text" id="modalInput" value="${oldName}" class="w-full bg-gray-700 border-gray-600 rounded-md px-3 py-2 text-white">`;
                showModal(`Rename Project`, content, [
                    { text: 'Cancel', class: 'px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-sm', onClick: closeModal },
                    { text: 'Rename', class: 'px-4 py-2 rounded-md bg-indigo-600 hover:bg-indigo-700 text-sm', onClick: async () => {
                        const newName = document.getElementById('modalInput').value.trim();
                        if (newName && newName !== oldName) {
                            await db.collection("users").doc(userId).collection("projects").doc(projectId).update({ name: newName });
                        }
                        closeModal();
                    }}
                ]);
            }

            async function handleDeleteProject(projectId, projectName) {
                const content = `<p>Are you sure you want to permanently delete <strong class="font-bold">${projectName}</strong> and all of its files and assets? This cannot be undone.</p>`;
                showModal('Delete Project', content, [
                    { text: 'Cancel', class: 'px-4 py-2 rounded-md bg-gray-600 hover:bg-gray-700 text-sm', onClick: closeModal },
                    { text: 'Delete', class: 'px-4 py-2 rounded-md bg-red-600 hover:bg-red-700 text-sm', onClick: async () => {
                        // This is a simplified cascading delete. For very large projects, a Cloud Function is more robust.
                        const batch = db.batch();
                        
                        // Delete files
                        const filesSnapshot = await db.collection("projects").doc(projectId).collection("files").get();
                        filesSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                        
                        // Delete assets
                        const assetsSnapshot = await db.collection("projects").doc(projectId).collection("assets").get();
                        assetsSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                        
                        await batch.commit();

                        // Delete the main project doc
                        await db.collection("users").doc(userId).collection("projects").doc(projectId).delete();

                        closeModal();
                    }}
                ]);
            }


            // --- Event Listeners ---
            DOM.newProjectBtn.onclick = handleCreateProject;
            DOM.backToProjectsBtn.onclick = () => showView('dashboard');
            DOM.saveButton.onclick = saveData;
            DOM.runButton.onclick = runProject;
            DOM.uploadFileBtn.onclick = () => DOM.fileUploader.click();
            DOM.fileUploader.onchange = handleFileUpload;
            DOM.newFileBtn.onclick = () => handleNewFile('root');
            DOM.newFolderBtn.onclick = () => handleNewFolder('root');
            DOM.git.connectBtn.onclick = connectToGit;
            DOM.git.disconnectBtn.onclick = disconnectFromGit;
            DOM.git.commitBtn.onclick = handleCommit;
            DOM.git.pushBtn.onclick = () => alert("Simulating a push to the remote repository!");
            DOM.git.pullBtn.onclick = () => alert("Simulating a pull from the remote repository!");
            DOM.assets.uploadBtn.onclick = () => DOM.assetUploader.click();
            DOM.assets.newFolderBtn.onclick = () => alert("Asset folder creation coming soon!");
            DOM.assetUploader.onchange = handleAssetUpload;
            
            // AI Settings Listeners
            DOM.editorAi.settingsBtn.onclick = showApiKeyModal;
            DOM.hubAi.settingsBtn.onclick = showApiKeyModal;
            DOM.canvasAi.settingsBtn.onclick = showApiKeyModal;

            // Editor AI Listeners
            DOM.editorAi.sendBtn.onclick = () => {
                const prompt = DOM.editorAi.input.value;
                const context = `You are an expert code assistant. Here is the current code I'm working on:\n\`\`\`\n${editor.getSelection() || editor.getValue()}\n\`\`\``;
                handleAIAssist(prompt, context, DOM.editorAi.chatContainer, 'editor-ai-loading');
                DOM.editorAi.input.value = '';
            };
            DOM.editorAi.input.onkeydown = (e) => { if (e.key === 'Enter') DOM.editorAi.sendBtn.click(); };
            DOM.editorAi.actionBtns.forEach(btn => {
                btn.onclick = () => {
                     const context = `You are an expert code assistant. Here is the current code I'm working on:\n\`\`\`\n${editor.getSelection() || editor.getValue()}\n\`\`\``;
                     handleAIAssist(btn.dataset.prompt, context, DOM.editorAi.chatContainer, 'editor-ai-loading');
                }
            });

            // Hub AI Listeners
            DOM.hubAi.sendBtn.onclick = () => {
                const prompt = DOM.hubAi.input.value;
                const context = `You are a helpful AI assistant.`;
                handleAIAssist(prompt, context, DOM.hubAi.chatContainer, 'hub-ai-loading');
                DOM.hubAi.input.value = '';
            };
            DOM.hubAi.input.onkeydown = (e) => { if (e.key === 'Enter') DOM.hubAi.sendBtn.click(); };

            // Canvas AI Listeners
            DOM.canvasAi.sendBtn.onclick = () => {
                const prompt = DOM.canvasAi.input.value;
                const context = `You are a helpful writing assistant. Here is the text from the editor:\n\n${canvasEditor.getValue()}`;
                handleAIAssist(prompt, context, DOM.canvasAi.chatContainer, 'canvas-ai-loading');
                DOM.canvasAi.input.value = '';
            };
            DOM.canvasAi.input.onkeydown = (e) => { if (e.key === 'Enter') DOM.canvasAi.sendBtn.click(); };
            DOM.canvasAi.actionBtns.forEach(btn => {
                 btn.onclick = () => {
                     const context = `You are a helpful writing assistant. Here is the text from the editor:\n\n${canvasEditor.getValue()}`;
                     handleAIAssist(btn.dataset.prompt, context, DOM.canvasAi.chatContainer, 'canvas-ai-loading');
                }
            });


            DOM.search.btn.onclick = handleProjectSearch;
            DOM.search.input.onkeydown = (e) => { if (e.key === 'Enter') handleProjectSearch(); };
            DOM.search.results.addEventListener('click', (e) => {
                const item = e.target.closest('.search-result-item');
                if (item) {
                    const { fileid, line } = item.dataset;
                    openFile(fileid, parseInt(line));
                }
            });
            DOM.snippets.newBtn.onclick = handleCreateSnippet;
            DOM.snippets.list.addEventListener('click', e => {
                if (e.target.classList.contains('insert-snippet-btn')) {
                    insertSnippet(e.target.dataset.id);
                }
            });

            DOM.devSuite.main.addEventListener('click', e => {
                const uploadBtn = e.target.closest('.devsuite-upload-btn');
                if (uploadBtn) {
                    devSuiteUploadTarget = uploadBtn.dataset.target;
                    DOM.fileUploader.click();
                }
            });

            DOM.projectList.addEventListener('click', e => {
                const openBtn = e.target.closest('.open-project-btn');
                const renameBtn = e.target.closest('.rename-project-btn');
                const deleteBtn = e.target.closest('.delete-project-btn');

                if (openBtn) {
                    selectProject(openBtn.dataset.projectId, openBtn.dataset.projectName);
                } else if (renameBtn) {
                    handleRenameProject(renameBtn.dataset.projectId, renameBtn.dataset.projectName);
                } else if (deleteBtn) {
                    handleDeleteProject(deleteBtn.dataset.projectId, deleteBtn.dataset.projectName);
                }
            });

            DOM.assets.list.addEventListener('click', e => {
                const copyBtn = e.target.closest('.copy-asset-content-btn');
                const deleteBtn = e.target.closest('.delete-asset-btn');

                if (copyBtn) {
                    const content = decodeURIComponent(copyBtn.dataset.content);
                    const textArea = document.createElement('textarea');
                    textArea.value = content;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        copyBtn.textContent = 'Copied!';
                        setTimeout(() => copyBtn.textContent = 'Copy Content', 2000);
                    } catch (err) {
                        console.error('Fallback: Oops, unable to copy', err);
                    }
                    document.body.removeChild(textArea);
                } else if (deleteBtn) {
                    handleDeleteAsset(deleteBtn.dataset.assetId, deleteBtn.dataset.assetName);
                }
            });

            DOM.git.mainView.addEventListener('click', (e) => {
                if (e.target.closest('.stage-btn')) {
                    stageFile(e.target.closest('.stage-btn').dataset.filename);
                }
                if (e.target.closest('.unstage-btn')) {
                    unstageFile(e.target.closest('.unstage-btn').dataset.filename);
                }
            });

            document.onclick = (e) => {
                if (!DOM.contextMenu.contains(e.target) && !e.target.closest('.item-menu-btn')) {
                    hideContextMenu();
                }
            };
            
            main();
        });
    </script>
</body>
</html>
